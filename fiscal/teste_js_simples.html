<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste JavaScript Fiscal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .kpi { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .log { background: #f5f5f5; padding: 10px; margin: 5px 0; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <h1>üß™ Teste JavaScript Fiscal</h1>
    
    <div class="kpi">
        <h3>üìä KPIs do Dashboard</h3>
        <p><strong>NF-e Total:</strong> <span id="nfeTotal">-</span></p>
        <p><strong>NF-e Pendentes:</strong> <span id="nfePendentes">-</span></p>
        <p><strong>NF-e Autorizadas:</strong> <span id="nfeAutorizadas">-</span></p>
        
        <p><strong>CT-e Total:</strong> <span id="cteTotal">-</span></p>
        <p><strong>CT-e Pendentes:</strong> <span id="ctePendentes">-</span></p>
        <p><strong>CT-e Autorizados:</strong> <span id="cteAutorizados">-</span></p>
        
        <p><strong>MDF-e Total:</strong> <span id="mdfeTotal">-</span></p>
        <p><strong>MDF-e Pendentes:</strong> <span id="mdfePendentes">-</span></p>
        <p><strong>MDF-e Autorizados:</strong> <span id="mdfeAutorizados">-</span></p>
    </div>
    
    <div class="kpi">
        <h3>üåê Status SEFAZ</h3>
        <div id="sefazStatus">-</div>
    </div>
    
    <div class="kpi">
        <h3>üìã Documentos Recentes</h3>
        <div id="nfeList">-</div>
        <div id="cteList">-</div>
        <div id="mdfeList">-</div>
    </div>
    
    <div class="kpi">
        <h3>üìù Log de Atividades</h3>
        <div id="logContainer"></div>
    </div>
    
    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(log);
        }
        
        // Fun√ß√£o para atualizar elemento se existir
        function updateElementIfExists(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                addLog(`‚úÖ Elemento ${elementId} atualizado: ${value}`, 'success');
            } else {
                addLog(`‚ö†Ô∏è Elemento n√£o encontrado: ${elementId}`, 'warning');
            }
        }
        
        // Fun√ß√£o para atualizar status SEFAZ
        function updateSefazStatus(status) {
            const statusElement = document.getElementById('sefazStatus');
            if (!statusElement) {
                addLog('‚ö†Ô∏è Elemento sefazStatus n√£o encontrado', 'warning');
                return;
            }

            const statusClass = status === 'online' ? 'success' : 'error';
            const statusText = status === 'online' ? 'Online' : 'Offline';
            const statusIcon = status === 'online' ? '‚úÖ' : '‚ùå';

            statusElement.innerHTML = `<span class="${statusClass}">${statusIcon} ${statusText}</span>`;
            addLog(`‚úÖ Status SEFAZ atualizado: ${statusText}`, 'success');
        }
        
        // Fun√ß√£o para atualizar KPIs
        function updateDashboardKPIs(data) {
            addLog('üîÑ Atualizando KPIs do dashboard...', 'info');
            
            // Atualizar KPI de NF-e
            if (data.nfe) {
                updateElementIfExists('nfeTotal', data.nfe.total || 0);
                updateElementIfExists('nfePendentes', data.nfe.pendentes || 0);
                updateElementIfExists('nfeAutorizadas', data.nfe.autorizadas || 0);
            }

            // Atualizar KPI de CT-e
            if (data.cte) {
                updateElementIfExists('cteTotal', data.cte.total || 0);
                updateElementIfExists('ctePendentes', data.cte.pendentes || 0);
                updateElementIfExists('cteAutorizados', data.cte.autorizados || 0);
            }

            // Atualizar KPI de MDF-e
            if (data.mdfe) {
                updateElementIfExists('mdfeTotal', data.mdfe.total || 0);
                updateElementIfExists('mdfePendentes', data.mdfe.pendentes || 0);
                updateElementIfExists('mdfeAutorizados', data.mdfe.autorizados || 0);
            }

            // Atualizar status SEFAZ
            if (data.sefaz_status) {
                updateSefazStatus(data.sefaz_status.status);
            }
            
            addLog('‚úÖ KPIs atualizados com sucesso!', 'success');
        }
        
        // Fun√ß√£o para carregar dashboard
        async function loadFiscalDashboard() {
            try {
                addLog('üöÄ Carregando dashboard fiscal...', 'info');
                
                const response = await fetch('/sistema-frotas/fiscal/api/fiscal_dashboard.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        empresa_id: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ Dashboard carregado com sucesso!', 'success');
                    updateDashboardKPIs(data.data);
                } else {
                    addLog(`‚ùå Erro ao carregar dashboard: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao carregar dashboard fiscal: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√£o para carregar documentos
        async function loadRecentDocuments() {
            try {
                addLog('üìã Carregando documentos recentes...', 'info');
                
                const response = await fetch('/sistema-frotas/fiscal/api/fiscal_documents.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        empresa_id: 1,
                        action: 'get_recent'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ Documentos carregados com sucesso!', 'success');
                    
                    // Atualizar listas
                    updateDocumentList('nfeList', data.data.nfe || [], 'NF-e');
                    updateDocumentList('cteList', data.data.cte || [], 'CT-e');
                    updateDocumentList('mdfeList', data.data.mdfe || [], 'MDF-e');
                } else {
                    addLog(`‚ùå Erro ao carregar documentos: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao carregar documentos: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√£o para atualizar lista de documentos
        function updateDocumentList(containerId, documents, type) {
            const container = document.getElementById(containerId);
            if (!container) {
                addLog(`‚ö†Ô∏è Container ${containerId} n√£o encontrado`, 'warning');
                return;
            }

            container.innerHTML = '';
            
            if (documents && documents.length > 0) {
                documents.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'log';
                    item.innerHTML = `<strong>${type}:</strong> ${doc.numero_nfe || doc.numero_cte || doc.numero_mdfe || doc.id} - ${doc.status}`;
                    container.appendChild(item);
                });
                addLog(`‚úÖ ${documents.length} ${type}(s) carregado(s)`, 'success');
            } else {
                container.innerHTML = `<div class="log warning">Nenhum ${type} encontrado</div>`;
                addLog(`‚ÑπÔ∏è Nenhum ${type} encontrado`, 'info');
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ P√°gina carregada, iniciando testes...', 'success');
            
            // Carregar dashboard
            loadFiscalDashboard();
            
            // Carregar documentos
            loadRecentDocuments();
        });
    </script>
</body>
</html>
